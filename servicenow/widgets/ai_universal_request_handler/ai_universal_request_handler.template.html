<div class="ai-request-container">
<div class="panel-header">
        <h3>
            <i class="fa fa-robot"></i> 
            <span ng-if="!data.isDutch">AI Universal Request Handler</span>
            <span ng-if="data.isDutch">AI Universele Aanvraag Verwerker</span>
        </h3>
        <p ng-if="!data.isDutch">Powered by advanced AI to understand and process your requests</p>
        <p ng-if="data.isDutch">Aangedreven door geavanceerde AI om uw aanvragen te begrijpen en te verwerken</p>
    </div>
    <div class="panel-body">
<div ng-if="!c.showQuestions && !c.submitted">
            <div class="form-group">
                <label class="form-label">
                    <i class="fa fa-comment"></i> 
                    <span ng-if="!data.isDutch">What can we help you with today?</span>
                    <span ng-if="data.isDutch">Waarmee kunnen we u vandaag helpen?</span>
                </label>
                <textarea
                    class="form-control"
                    ng-model="c.initialRequest"
                    rows="4"
                    placeholder="{{data.isDutch ? 'Beschrijf uw aanvraag in detail...' : 'Describe your request in detail...'}}"
                    ng-disabled="c.processing">
                </textarea>
            </div>

            <div class="form-actions text-center">
                <button 
                    class="btn btn-primary btn-lg" 
                    ng-click="c.generateResponse()" 
                    ng-disabled="!c.initialRequest || c.processing">
                    <i class="fa" ng-class="{'fa-spinner fa-spin': c.processing, 'fa-brain': !c.processing}"></i>
                    <span ng-if="!data.isDutch">{{c.processing ? 'Analyzing Request...' : 'Get AI Response'}}</span>
                    <span ng-if="data.isDutch">{{c.processing ? 'Aanvraag Analyseren...' : 'AI Reactie Krijgen'}}</span>
                </button>
            </div>
        </div>
<div ng-if="c.processing" class="text-center loading-spinner">
            <i class="fa fa-spinner fa-spin fa-3x"></i>
            <p ng-if="!data.isDutch">{{c.processingMessage || 'Processing...'}}</p>
            <p ng-if="data.isDutch">{{c.processingMessage || 'Verwerken...'}}</p>
            <!-- Show processing steps for transparency -->
            <div ng-if="c.processingSteps.length > 0" class="processing-steps">
                <div ng-repeat="step in c.processingSteps" class="processing-step" ng-class="{'step-active': step.status === 'active', 'step-completed': step.status === 'completed'}">
                    <i class="fa" ng-class="{'fa-spinner fa-spin': step.status === 'active', 'fa-check': step.status === 'completed'}"></i>
                    <span>{{step.message}}</span>
                </div>
            </div>
        </div>
<div ng-if="c.errorMessage" class="alert alert-danger">
            <i class="fa fa-exclamation-triangle"></i>
            <strong ng-if="!data.isDutch">Error:</strong>
            <strong ng-if="data.isDutch">Fout:</strong> {{c.errorMessage}}
            <button class="btn btn-sm btn-default pull-right" ng-click="c.clearError()">
                <i class="fa fa-times"></i>
            </button>
        </div>
<div ng-if="c.showResponse && (c.responseType === 'simple_question' || c.responseType === 'service_request') && !c.processing" class="ai-response-section">
            <div class="ai-response-header">
                <h4>
                    <i class="fa" ng-class="{'fa-lightbulb-o': c.responseType === 'simple_question', 'fa-shopping-cart': c.responseType === 'service_request'}"></i>
                    <span ng-if="!data.isDutch && c.responseType === 'simple_question'">AI Answer</span>
                    <span ng-if="data.isDutch && c.responseType === 'simple_question'">AI Antwoord</span>
                    <span ng-if="!data.isDutch && c.responseType === 'service_request'">Service Request</span>
                    <span ng-if="data.isDutch && c.responseType === 'service_request'">Service Aanvraag</span>
                </h4>
                <p class="text-muted" ng-if="!data.isDutch && c.responseType === 'simple_question'">Here's the answer to your question:</p>
                <p class="text-muted" ng-if="data.isDutch && c.responseType === 'simple_question'">Hier is het antwoord op uw vraag:</p>
            </div>
            <div class="ai-direct-answer">
                <div class="answer-content">
                    <i class="fa fa-quote-left"></i>
                    <div ng-bind-html="c.directAnswer"></div>

                    <!-- Integrated Catalog Items Section for service_request -->
                    <div ng-if="c.responseType === 'service_request' && c.showCatalogItems && c.catalogItems.length > 0" class="catalog-items-integrated">
                        <div class="catalog-section-header">
                            <h5><i class="fa fa-shopping-cart"></i>
                                <span ng-if="!data.isDutch">Available Service Catalog Items:</span>
                                <span ng-if="data.isDutch">Beschikbare Service Catalogus Items:</span>
                            </h5>
                        </div>
                        <div class="catalog-list">
                            <div ng-repeat="item in c.catalogItems" class="catalog-item-button">
                                <a ng-href="{{item.link}}" target="_blank" class="btn btn-primary btn-block" title="{{item.fullDescription || item.description}}">
                                    <div class="catalog-item-content">
                                        <div class="catalog-item-main">
                                            <i class="fa fa-external-link"></i>
                                            <strong>{{item.name}}</strong>
                                        </div>
                                        <div ng-if="item.description" class="catalog-item-desc">
                                            {{item.description}}
                                        </div>
                                    </div>
                                </a>
                            </div>
                        </div>
                    </div>

                    <i class="fa fa-quote-right pull-right"></i>
                </div>
            </div>

            <!-- Form actions - moved below content for service_request -->
            <div class="form-actions" ng-if="c.responseType === 'simple_question'">
                <button class="btn btn-success" ng-click="c.resetForm()">
                    <i class="fa fa-plus"></i>
                    <span ng-if="!data.isDutch">Ask Another Question</span>
                    <span ng-if="data.isDutch">Stel Nog Een Vraag</span>
                </button>
                <button class="btn btn-default" ng-click="c.createTicketDirectly()" ng-if="c.showTicketOption">
                    <i class="fa fa-ticket"></i>
                    <span ng-if="!data.isDutch">Still Need Support Ticket</span>
                    <span ng-if="data.isDutch">Nog Steeds Support Ticket Nodig</span>
                </button>
            </div>

            <!-- Separate actions for service_request - below catalog items -->
            <div class="form-actions" ng-if="c.responseType === 'service_request'">
                <button class="btn btn-success" ng-click="c.resetForm()">
                    <i class="fa fa-plus"></i>
                    <span ng-if="!data.isDutch">Make Another Request</span>
                    <span ng-if="data.isDutch">Doe Nog Een Aanvraag</span>
                </button>
                <button class="btn btn-default" ng-click="c.createTicketDirectly()" ng-if="c.showTicketOption">
                    <i class="fa fa-ticket"></i>
                    <span ng-if="!data.isDutch && !c.hasCatalogItems">Still Need Support Ticket</span>
                    <span ng-if="data.isDutch && !c.hasCatalogItems">Nog Steeds Support Ticket Nodig</span>
                    <span ng-if="!data.isDutch && c.hasCatalogItems">None of These Match My Request</span>
                    <span ng-if="data.isDutch && c.hasCatalogItems">Geen Van Deze Past Bij Mijn Aanvraag</span>
                </button>
            </div>
        </div>
<div ng-if="c.showResponse && c.responseType === 'incident' && !c.processing" class="ai-suggestions-section">
            <div class="ai-suggestions-header">
                <h4><i class="fa fa-wrench"></i> 
                    <span ng-if="!data.isDutch">AI Suggestions</span>
                    <span ng-if="data.isDutch">AI Suggesties</span>
                </h4>
                <p class="text-muted" ng-if="!data.isDutch">Try these suggestions first - they might resolve your issue quickly:</p>
                <p class="text-muted" ng-if="data.isDutch">Probeer eerst deze suggesties - ze kunnen uw probleem snel oplossen:</p>
            </div>
            <div class="suggestions-list">
                <div ng-repeat="suggestion in c.suggestions" class="suggestion-item">
                    <span class="suggestion-number">{{$index + 1}}</span>
                    <span class="suggestion-text" ng-bind-html="suggestion"></span>
                </div>
            </div>
            <div class="suggestions-response">
                <h5 ng-if="!data.isDutch">Have you tried these suggestions?</h5>
                <h5 ng-if="data.isDutch">Heeft u deze suggesties geprobeerd?</h5>
                <div class="suggestion-buttons">
                    <button class="btn btn-success" ng-click="c.handleSuggestionResponse('resolved')">
                        <i class="fa fa-check-circle"></i> 
                        <span ng-if="!data.isDutch">Yes, tried them and no longer need a ticket</span>
                        <span ng-if="data.isDutch">Ja, geprobeerd en heb geen ticket meer nodig</span>
                    </button>
                    <button class="btn btn-primary" ng-click="c.handleSuggestionResponse('proceed')">
                        <i class="fa fa-arrow-right"></i> 
                        <span ng-if="!data.isDutch">Proceed to create ticket</span>
                        <span ng-if="data.isDutch">Doorgaan met ticket aanmaken</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Knowledge Articles Section -->
        <div ng-if="c.showKnowledgeSources && c.knowledgeSources.length > 0" class="knowledge-articles-section">
            <div class="section-header">
                <h5><i class="fa fa-book"></i>
                    <span ng-if="!data.isDutch">Related Knowledge Articles</span>
                    <span ng-if="data.isDutch">Gerelateerde Kennisartikelen</span>
                </h5>
            </div>
            <div class="knowledge-list">
                <div ng-repeat="article in c.knowledgeSources" class="knowledge-item">
                    <a ng-href="{{article.link}}" target="_blank" class="knowledge-link">
                        <i class="fa fa-file-text-o"></i>
                        <span class="knowledge-title">{{article.title}}</span>
                        <span class="knowledge-number">({{article.number}})</span>
                    </a>
                    <p class="knowledge-preview" ng-if="article.snippet">{{article.snippet}}</p>
                </div>
            </div>
        </div>


<div ng-if="c.showQuestions && !c.submitted && !c.processing">
            <div class="ai-questions-header">
                <h4><i class="fa fa-list-check"></i> Please answer the following questions:</h4>
                <p class="text-muted">AI has generated specific questions based on your request</p>
            </div>
            <form name="questionsForm">
                <div ng-repeat="question in c.aiQuestions" class="question-item">
                    <label class="question-label">
                        <span class="question-number">{{$index + 1}}</span>
                        {{question.question}}
                        <span ng-if="question.required" class="text-danger">*</span>
                    </label>
<input 
                        ng-if="!question.type || question.type === 'text' || question.type === 'email' || question.type === 'phone' || question.type === 'number'"
                        type="{{question.type || 'text'}}"
                        class="form-control"
                        ng-model="c.responses[$index]"
                        ng-required="question.required"
                        placeholder="{{question.placeholder || (data.isDutch ? 'Voer uw antwoord in' : 'Enter your answer')}}"
                    />
<textarea 
                        ng-if="question.type === 'textarea'"
                        class="form-control"
                        ng-model="c.responses[$index]"
                        ng-required="question.required"
                        rows="3"
                        placeholder="{{question.placeholder || (data.isDutch ? 'Voer uw antwoord in' : 'Enter your answer')}}"
                    ></textarea>
<select 
                        ng-if="question.type === 'select' || question.type === 'dropdown'"
                        class="form-control"
                        ng-model="c.responses[$index]"
                        ng-required="question.required">
                        <option value="">-- Select an option --</option>
                        <option ng-repeat="option in question.options" value="{{option}}">{{option}}</option>
                    </select>
<div ng-if="question.type === 'radio'" class="radio-group">
                        <div class="radio" ng-repeat="option in question.options">
                            <label>
                                <input 
                                    type="radio"
                                    name="question_{{$parent.$index}}"
                                    ng-model="c.responses[$parent.$index]"
                                    value="{{option}}"
                                    ng-required="question.required"
                                />
                                {{option}}
                            </label>
                        </div>
<div ng-if="!question.options || question.options.length === 0">
                            <div class="radio">
                                <label>
                                    <input 
                                        type="radio"
                                        name="question_{{$index}}"
                                        ng-model="c.responses[$index]"
                                        value="Yes"
                                        ng-required="question.required"
                                    />
                                    <span ng-if="!data.isDutch">Yes</span>
                                    <span ng-if="data.isDutch">Ja</span>
                                </label>
                            </div>
                            <div class="radio">
                                <label>
                                    <input 
                                        type="radio"
                                        name="question_{{$index}}"
                                        ng-model="c.responses[$index]"
                                        value="No"
                                        ng-required="question.required"
                                    />
                                    <span ng-if="!data.isDutch">No</span>
                                    <span ng-if="data.isDutch">Nee</span>
                                </label>
                            </div>
                        </div>
                    </div>
<div ng-if="question.type === 'checkbox'" class="checkbox-group">
                        <div class="checkbox" ng-repeat="option in question.options">
                            <label>
                                <input 
                                    type="checkbox"
                                    ng-model="c.checkboxResponses[$parent.$index][option]"
                                    ng-change="c.updateCheckboxResponse($parent.$index)"
                                />
                                {{option}}
                            </label>
                        </div>
<div ng-if="!question.options || question.options.length === 0" class="checkbox">
                            <label>
                                <input 
                                    type="checkbox"
                                    ng-model="c.responses[$index]"
                                    ng-true-value="'Yes'"
                                    ng-false-value="'No'"
                                />
                                {{question.checkboxLabel || (data.isDutch ? 'Vink aan indien van toepassing' : 'Check if applicable')}}
                            </label>
                        </div>
                    </div>
<input 
                        ng-if="question.type === 'date' || question.type === 'datetime' || question.type === 'datetime-local'"
                        type="{{question.type === 'datetime' ? 'datetime-local' : question.type}}"
                        class="form-control"
                        ng-model="c.responses[$index]"
                        ng-required="question.required"
                    />
<div ng-if="question.type === 'priority'" class="priority-scale">
                        <div class="priority-option">
                            <label class="priority-label priority-critical">
                                <input type="radio" name="priority_{{$index}}" ng-model="c.responses[$index]" value="1" ng-required="question.required"/>
                                <span class="priority-text" ng-if="!data.isDutch">1 - Critical</span>
                                <span class="priority-text" ng-if="data.isDutch">1 - Kritiek</span>
                            </label>
                        </div>
                        <div class="priority-option">
                            <label class="priority-label priority-high">
                                <input type="radio" name="priority_{{$index}}" ng-model="c.responses[$index]" value="2" ng-required="question.required"/>
                                <span class="priority-text" ng-if="!data.isDutch">2 - High</span>
                                <span class="priority-text" ng-if="data.isDutch">2 - Hoog</span>
                            </label>
                        </div>
                        <div class="priority-option">
                            <label class="priority-label priority-medium">
                                <input type="radio" name="priority_{{$index}}" ng-model="c.responses[$index]" value="3" ng-required="question.required"/>
                                <span class="priority-text" ng-if="!data.isDutch">3 - Moderate</span>
                                <span class="priority-text" ng-if="data.isDutch">3 - Gemiddeld</span>
                            </label>
                        </div>
                        <div class="priority-option">
                            <label class="priority-label priority-low">
                                <input type="radio" name="priority_{{$index}}" ng-model="c.responses[$index]" value="4" ng-required="question.required"/>
                                <span class="priority-text" ng-if="!data.isDutch">4 - Low</span>
                                <span class="priority-text" ng-if="data.isDutch">4 - Laag</span>
                            </label>
                        </div>
                    </div>
<select 
                        ng-if="question.type === 'yesno' || question.type === 'boolean'"
                        class="form-control"
                        ng-model="c.responses[$index]"
                        ng-required="question.required">
                        <option value="" ng-if="!data.isDutch">-- Select --</option>
                        <option value="" ng-if="data.isDutch">-- Selecteer --</option>
                        <option value="Yes" ng-if="!data.isDutch">Yes</option>
                        <option value="Yes" ng-if="data.isDutch">Ja</option>
                        <option value="No" ng-if="!data.isDutch">No</option>
                        <option value="No" ng-if="data.isDutch">Nee</option>
                    </select>
<div ng-if="question.type && question.type !== 'text' && question.type !== 'email' && question.type !== 'phone' && question.type !== 'number' && question.type !== 'textarea' && question.type !== 'select' && question.type !== 'dropdown' && question.type !== 'radio' && question.type !== 'checkbox' && question.type !== 'date' && question.type !== 'datetime' && question.type !== 'datetime-local' && question.type !== 'priority' && question.type !== 'yesno' && question.type !== 'boolean'">
                        <small class="text-warning" ng-if="!data.isDutch">Unknown field type '{{question.type}}' - using text input</small>
                        <small class="text-warning" ng-if="data.isDutch">Onbekend veld type '{{question.type}}' - tekst invoer wordt gebruikt</small>
                        <input 
                            type="text"
                            class="form-control"
                            ng-model="c.responses[$index]"
                            ng-required="question.required"
                            placeholder="{{question.placeholder || (data.isDutch ? 'Voer uw antwoord in' : 'Enter your answer')}}"
                        />
                    </div>
                </div>

                <!-- Screenshot Upload Section (only for incidents) -->
                <div ng-if="c.responseType === 'incident'" class="form-group screenshot-upload-section">
                    <label class="form-label">
                        <i class="fa fa-camera"></i>
                        <span ng-if="!data.isDutch">Attach Screenshots (optional)</span>
                        <span ng-if="data.isDutch">Voeg Screenshots Toe (optioneel)</span>
                    </label>
                    <p class="help-text" ng-if="!data.isDutch">
                        You can attach up to 5 screenshots to help explain your issue (max 10MB per file)
                    </p>
                    <p class="help-text" ng-if="data.isDutch">
                        U kunt maximaal 5 screenshots toevoegen om uw probleem te verduidelijken (max 10MB per bestand)
                    </p>
                    <input
                        type="file"
                        id="screenshot-upload-questions"
                        accept="image/*"
                        multiple
                        style="display: none;"
                        onchange="angular.element(this).scope().c.handleScreenshotUpload(this.files)"
                    />
                    <button
                        type="button"
                        class="btn btn-default"
                        ng-click="c.triggerScreenshotUpload()"
                        ng-disabled="c.screenshots.length >= 5">
                        <i class="fa fa-upload"></i>
                        <span ng-if="!data.isDutch">Upload Screenshots</span>
                        <span ng-if="data.isDutch">Upload Screenshots</span>
                    </button>
                    <div ng-if="c.screenshots.length > 0" class="screenshot-preview-area">
                        <div ng-repeat="screenshot in c.screenshots" class="screenshot-preview-item">
                            <img ng-src="{{screenshot.dataUrl}}" alt="{{screenshot.name}}" class="screenshot-thumbnail" />
                            <div class="screenshot-info">
                                <strong>{{screenshot.name}}</strong>
                                <small>{{(screenshot.size / 1024).toFixed(0)}} KB</small>
                            </div>
                            <button
                                type="button"
                                class="btn btn-sm btn-danger screenshot-remove"
                                ng-click="c.removeScreenshot($index)"
                                title="{{data.isDutch ? 'Verwijderen' : 'Remove'}}">
                                <i class="fa fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </form>
<div class="form-actions">
                <button
                    class="btn btn-success btn-lg"
                    ng-click="c.submitRequest()"
                    ng-disabled="questionsForm.$invalid || c.processing">
                    <i class="fa" ng-class="{'fa-spinner fa-spin': c.processing, 'fa-check': !c.processing}"></i>
                    <span ng-if="!data.isDutch">{{c.processing ? 'Submitting...' : 'Submit Request'}}</span>
                    <span ng-if="data.isDutch">{{c.processing ? 'Indienen...' : 'Aanvraag Indienen'}}</span>
                </button>
                <button 
                    class="btn btn-default btn-lg" 
                    ng-click="c.goBack()">
                    <i class="fa fa-arrow-left"></i> 
                    <span ng-if="!data.isDutch">Back</span>
                    <span ng-if="data.isDutch">Terug</span>
                </button>
                <button 
                    class="btn btn-warning btn-lg" 
                    ng-click="c.generateQuestions()">
                    <i class="fa fa-refresh"></i> 
                    <span ng-if="!data.isDutch">Regenerate</span>
                    <span ng-if="data.isDutch">Opnieuw Genereren</span>
                </button>
            </div>
        </div>
<div ng-if="c.submitted" class="alert alert-success">
            <h4><i class="fa fa-check-circle"></i> 
                <span ng-if="!data.isDutch">Request Submitted Successfully!</span>
                <span ng-if="data.isDutch">Aanvraag Succesvol Ingediend!</span>
            </h4>
            <p ng-if="!data.isDutch">Your {{c.finalRequestType || 'request'}} has been created.</p>
            <p ng-if="data.isDutch">Uw {{c.finalRequestType || 'aanvraag'}} is aangemaakt.</p>
            <p ng-if="c.createdRecordNumber && !data.isDutch"><strong>Record Number:</strong> {{c.createdRecordNumber}}</p>
            <p ng-if="c.createdRecordNumber && data.isDutch"><strong>Record Nummer:</strong> {{c.createdRecordNumber}}</p>
            <div class="form-actions">
                <button class="btn btn-success" ng-click="c.resetForm()">
                    <i class="fa fa-plus"></i> 
                    <span ng-if="!data.isDutch">Create Another Request</span>
                    <span ng-if="data.isDutch">Maak Nog Een Aanvraag</span>
                </button>
            </div>
        </div>
    </div>
</div>